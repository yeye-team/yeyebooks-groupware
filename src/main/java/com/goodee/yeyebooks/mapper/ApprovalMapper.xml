<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goodee.yeyebooks.mapper.ApprovalMapper">
	
	<!-- 결제 문서 추가 --> 
	<insert id="insertApproval" parameterType="com.goodee.yeyebooks.vo.Approval">
		INSERT INTO
			approval(
				user_id, doc_cat_cd, 
				aprv_title, aprv_contents,
				aprv_ymd, rjct_reason, 
				reference, c_date, u_date
				)
		VALUES (
			#{user_id},
			#{doc_cat_cd},
			#{aprc_title},
			#{aprv_contents},
			#{aprv_ymd},
			#{rjct_reason},
			#{reference},
			NOW(),
			NOW()
		)
	</insert>
	
	<!-- 결재첨부파일 -->
	<insert id="insertApprovalFile" parameterType="com.goodee.yeyebooks.vo.ApprovalFile">
		INSERT INTO
			approval_file(
				aprv_no, orgin_filename,
				save_filename, filetype,
				path
			)
		VALUES(
			#{orgin_filename},
			#{save_filename},
			#{filetype},
			#{path}
		)
			
	</insert>
	
	<!-- 결재선 -->
	<insert id="insertApprovalLine" parameterType="com.goodee.yeyebooks.vo.ApprovalLine">
		INSERT INTO
			approbal_line(
				aprv_no, user_id,
				aprv_yn, aprv_sequence
				aprv_ymd
			)
		VALUES(
			#{user_id},
			#{aprv_yn},
			#{aprv_sequence},
			NOW()
		)
	</insert>
	
	
	<!-- 내 문서함 -->
	<select id="selectMyApproval" parameterType="java.util.Map" resultType="com.goodee.yeyebooks.vo.Approval">
		SELECT 
			a.aprv_no aprvNo, a.user_id userId,
			a.doc_cat_cd docCatCd, c1.code_nm codeNm, a.aprv_title aprvTitle,
			a.aprv_contents aprvContents, a.aprv_ymd aprvYmd,
			a.rjct_reason rjctReason, a.aprv_stat_cd aprvStatCd, c2.code_nm codeName,
			a.reference, a.c_date cDate,
			af.orgin_filename orginFilename, af.save_filename saveFilename,
			al.aprv_stat_cd aprvStatCd, al.aprv_ymd as aprv_line_ymd
		FROM approval a
		LEFT JOIN approval_file af ON a.aprv_no = af.aprv_no
		LEFT JOIN approval_line al ON a.aprv_no = al.aprv_no
		LEFT JOIN common_code c1 ON a.doc_cat_cd = c1.code AND c1.group_code = 'A002'
		LEFT JOIN common_code c2 ON a.aprv_stat_cd = c2.code AND c2.group_code = 'A001'
		<choose>
	         <when test="status == 2">
	            WHERE a.user_id = 'admin'
	         </when>
	         <when test="status == 3">
	            WHERE al.user_id = 'admin'
	         </when>
			<otherwise>
				WHERE (a.user_id = 'admin' OR al.user_id = 'admin' OR a.reference LIKE '%admin%')
			</otherwise>
		</choose>
		<choose>
			<when test="status == 1"> AND c2.code =  '01' </when>
			<when test="status == 2"> AND c2.code =  '01' </when>
			<when test="status == 3"> AND c2.code =  '01' </when>
			<when test="status == 4"> AND c2.code =  '02' </when>
			<when test="status == 5"> AND c2.code =  '03' </when>
			<when test="status == 6"> AND c2.code =  '04' </when>
		</choose>

		ORDER BY a.aprv_ymd DESC;
		
	</select>
	
	<!-- 각 상태 별 문서 -->
	<!-- <select id="selectApprovalByStatus" parameterType="map" resultType="com.goodee.yeyebooks.vo.Approval">
		SELECT 
			a.aprv_no aprvNo, a.user_id userId,
			a.doc_cat_cd docCatCd, c1.code_nm codeNm, a.aprv_title aprvTitle,
			a.aprv_contents aprvContents, a.aprv_ymd aprvYmd,
			a.rjct_reason rjctReason, a.aprv_stat_cd aprvStatCd, c2.code_nm codeName,
			a.reference, a.c_date cDate,
			af.orgin_filename orginFilename, af.save_filename saveFilename,
			al.aprv_yn aprvYn, al.aprv_ymd as aprv_line_ymd
		FROM approval a
		LEFT JOIN approval_file af ON a.aprv_no = af.aprv_no
		LEFT JOIN approval_line al ON a.aprv_no = al.aprv_no
		LEFT JOIN common_code c1 ON a.doc_cat_cd = c1.code AND c1.group_code = 'A002'
		LEFT JOIN common_code c2 ON a.aprv_stat_cd = c2.code AND c2.group_code = 'A001'
		WHERE (a.user_id = 'admin' OR al.user_id = 'admin' OR a.reference LIKE '%admin%')
		ORDER BY a.aprv_ymd DESC;
	</select> -->

	<!-- 공통코드 상태값 불러오기 -->
	<!-- <select id="selectApprovalCode" parameterType="string" resultType="string">
		SELECT code_nm
		FROM common_code
		WHERE group_code = 'A001'
		AND code = '01'
	</select> -->
	
	<!-- 게시물 개수 조회 -->
	<select id="selectApprovalCount">
		SELECT COUNT(*)
		FROM approval 
		WHER doc_cat_cd = #{docCatCd}
	</select>
	
	<!-- 
	<select id="selectApprovalByStatus" parameterType="com.goodee.yeyebooks.vo.Approval" resultType="com.goodee.yeyebooks.vo.Approval">
	    
	    SELECT 
			a.aprv_no, a.user_id,
			a.doc_cat_cd, a.aprv_title,
			a.aprv_contents, a.aprv_ymd,
			a.rjct_reason, a.aprv_stat_cd,
			a.reference, a.c_date,
			af.orgin_filename, af.save_filename,
			al.aprv_yn, al.aprv_ymd as aprv_line_ymd
		FROM approval a
		LEFT JOIN approval_file af ON a.aprv_no = af.aprv_no
		LEFT JOIN approval_line al ON a.aprv_no = al.aprv_no
	</select> 
	-->

	
	
	
	<!-- 반려/회수된 문서 -->
	<!-- <select id="selectRejectedDocuments" parameterType="com.goodee.yeyebooks.vo.Approval" resultType="com.goodee.yeyebooks.vo.Approval">
		SELECT 
			a.aprv_no, a.user_id,
			a.doc_cat_cd, a.aprv_title,
			a.aprv_contents, a.aprv_ymd,
			a.rjct_reason, a.aprv_stat_cd,
			a.reference, a.c_date,
			af.orgin_filename, af.save_filename,
			al.aprv_yn, al.aprv_ymd as aprv_line_ymd
		FROM approval a
		LEFT JOIN approval_file af ON a.aprv_no = af.aprv_no
		LEFT JOIN approval_line al ON a.aprv_no = al.aprv_no
		WHERE a.user_id = #{loginId}
		AND (a.aprv_stat_cd = #{rejectedStatus} OR a.aprv_stat_cd = #{withdrawnStatus})
		ORDER BY a.aprv_ymd DESC;
	</select> -->
	
	<!-- 문서 상세보기 -->
	<select id="selectApprovalOne" parameterType="com.goodee.yeyebooks.vo.Approval" resultType="com.goodee.yeyebooks.vo.Approval">
		SELECT
			a.aprv_no aprvNo, a.user_id userId,
			a.doc_cat_cd docCatCd, a.aprv_title aprvTitle,
			a.aprv_contents aprvContents, a.aprv_ymd aprvYmd,
			a.rjct_reason rjctReason, a.aprv_stat_cd aprvStat,
			a.reference,
			a.c_date cDate,
			a.u_date uDate,
			u.user_nm userName,
			u.rank_cd, u.dept_cd,
			c1.code_nm rankName,
			c2.code_nm deptName,
			al.aprv_stat_cd lineAprvStat,
			al.aprv_ymd lineAprvYmd,
			al.aprv_sequence aprvSequence
		FROM approval AS a
		JOIN user AS u ON a.user_id = u.user_id
		LEFT JOIN common_code AS c1 ON u.rank_cd = c1.code AND c1.group_code = 'R001'
		LEFT JOIN common_code AS c2 ON u.dept_cd = c2.code AND c2.group_code = 'D001'
		LEFT JOIN approval_line AS al ON a.aprv_no = al.aprv_no
		WHERE a.aprv_no = '1'
		ORDER BY al.aprv_sequence;
	</select> 
	
	<!-- 문서처리 -->
	<update id="updateApprovalProcessed" parameterType="com.goodee.yeyebooks.vo.Approval">
		UPDATE approval
		SET aprv_yn = '1', 
			aprv_ymd = NOW(), 
			signature = #{signature} 
		WHERE aprv_no = #{aprv_no} 
		AND user_id = #{user_id};
	</update>
	
	<!-- 문서회수 -->
	<update id="updateApprovalWithDrawn" parameterType="com.goodee.yeyebooks.vo.Approval">
		UPDATE approval
		SET aprv_stat_cd = #{withdrawnStatus},
			aprv_ymd = NOW(),
			rjct_reason = #{withdrawReason}
		WHERE aprv_no = #{aprv_no} 
		AND user_id = #{loginId};
	</update>
	<select id="selectApprovalWaitingCnt" resultType="int">
		SELECT COUNT(*)
		FROM approval INNER JOIN approval_line
		ON approval.aprv_no = approval_line.aprv_no
		WHERE approval_line.user_id = #{userId}
		AND approval_line.aprv_stat_cd = (SELECT CODE 
										FROM common_code 
										WHERE group_code = 'A001' 
										AND code_nm = '진행중')
	</select>
	
	<select id="selectApproveWaitingCnt" resultType="int">
		SELECT COUNT(*)
		FROM approval
		WHERE user_id = #{userId}
		AND approval.aprv_stat_cd = (SELECT CODE 
									FROM common_code 
									WHERE group_code = 'A001' 
									AND code_nm = '진행중')
	</select>
</mapper>